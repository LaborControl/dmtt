@page "/"
@using LaborControl.Dashboard.Services
@inject ApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>Dashboard DMTT - Responsable Qualité</PageTitle>

@if (isLoading)
{
    <div class="loading-container">
        <div class="spinner-border text-purple" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="text-slate-400 mt-3">Chargement des données...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="error-container">
        <div class="alert alert-danger">
            <h5>Erreur de chargement</h5>
            <p>@errorMessage</p>
            <button class="btn btn-outline-danger" @onclick="LoadData">Réessayer</button>
        </div>
    </div>
}
else
{
    <div class="dashboard">
        <h1 class="text-white mb-4">Tableau de Bord</h1>
        <p class="text-slate-400 mb-4">Démantèlement Tricastin - Traçabilité Soudage & CND</p>

        <!-- KPI Cards Row -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-blue">
                    <div class="stat-icon">[S]</div>
                    <div class="stat-content">
                        <div class="stat-value">@dashboard.TotalWelds</div>
                        <div class="stat-label">Soudures totales</div>
                    </div>
                    <div class="stat-trend positive">@dashboard.InProgressWelds en cours</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-green">
                    <div class="stat-icon">[OK]</div>
                    <div class="stat-content">
                        <div class="stat-value">@dashboard.CompletedWelds</div>
                        <div class="stat-label">Soudures terminées</div>
                    </div>
                    <div class="stat-trend positive">@dashboard.ConformityRate% conformes</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-orange">
                    <div class="stat-icon">[C]</div>
                    <div class="stat-content">
                        <div class="stat-value">@dashboard.PendingNDTControl</div>
                        <div class="stat-label">CND en attente</div>
                    </div>
                    <div class="stat-trend neutral">À contrôler</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-red">
                    <div class="stat-icon">[!]</div>
                    <div class="stat-content">
                        <div class="stat-value">@dashboard.WithNonConformities</div>
                        <div class="stat-label">FNC ouvertes</div>
                    </div>
                    <div class="stat-trend negative">@dashboard.BlockedWelds bloquées</div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="row g-4 mb-4">
            <!-- Status Breakdown -->
            <div class="col-lg-8">
                <div class="card bg-slate-800 border-0">
                    <div class="card-header bg-transparent border-0 text-white">
                        <h5 class="mb-0">Répartition par Statut</h5>
                    </div>
                    <div class="card-body">
                        <div class="status-grid">
                            @foreach (var status in dashboard.StatusBreakdown)
                            {
                                <div class="status-item">
                                    <div class="status-count">@status.Count</div>
                                    <div class="status-label">@GetStatusLabel(status.Status)</div>
                                    <div class="status-bar">
                                        <div class="status-fill @GetStatusColor(status.Status)"
                                             style="width: @GetStatusPercentage(status.Count)%"></div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="col-lg-4">
                <div class="card bg-slate-800 border-0">
                    <div class="card-header bg-transparent border-0 text-white">
                        <h5 class="mb-0">Statistiques</h5>
                    </div>
                    <div class="card-body">
                        <div class="quick-stats">
                            <div class="quick-stat-item">
                                <span class="stat-name text-slate-400">Validation CCPU en attente</span>
                                <span class="stat-num text-warning">@dashboard.PendingCCPUValidation</span>
                            </div>
                            <div class="quick-stat-item">
                                <span class="stat-name text-slate-400">Soudures planifiées</span>
                                <span class="stat-num text-info">@dashboard.PlannedWelds</span>
                            </div>
                            <div class="quick-stat-item">
                                <span class="stat-name text-slate-400">Soudures bloquées</span>
                                <span class="stat-num text-danger">@dashboard.BlockedWelds</span>
                            </div>
                            <div class="quick-stat-item">
                                <span class="stat-name text-slate-400">Taux de conformité</span>
                                <span class="stat-num text-success">@dashboard.ConformityRate%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Third Row - Non-Conformities -->
        <div class="row g-4">
            <div class="col-12">
                <div class="card bg-slate-800 border-0">
                    <div class="card-header bg-transparent border-0 text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Non-Conformités Récentes</h5>
                        <a href="/non-conformities" class="btn btn-sm btn-outline-danger">Voir tout</a>
                    </div>
                    <div class="card-body">
                        @if (recentNCs.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Référence</th>
                                            <th>Type</th>
                                            <th>Sévérité</th>
                                            <th>Soudure</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var nc in recentNCs.Take(5))
                                        {
                                            <tr>
                                                <td class="fw-bold text-danger">@nc.Reference</td>
                                                <td><span class="badge bg-slate-600">@nc.NCType</span></td>
                                                <td><span class="badge @GetSeverityClass(nc.Severity)">@nc.Severity</span></td>
                                                <td class="text-slate-400">@(nc.WeldReference ?? "-")</td>
                                                <td><span class="badge @GetNCStatusClass(nc.Status)">@nc.Status</span></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-slate-400 text-center py-4 mb-0">Aucune non-conformité ouverte</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private WeldDashboardDto dashboard = new();
    private List<NonConformityDto> recentNCs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Load dashboard stats
            var dashboardResult = await ApiClient.GetWeldDashboardAsync();
            if (dashboardResult != null)
            {
                dashboard = dashboardResult;
            }

            // Load recent non-conformities
            var ncsResult = await ApiClient.GetOpenNonConformitiesAsync();
            if (ncsResult != null)
            {
                recentNCs = ncsResult;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Impossible de charger les données: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetStatusLabel(string status) => status switch
    {
        "PLANNED" => "Planifiées",
        "IN_PROGRESS" => "En cours",
        "PENDING_CCPU" => "Att. CCPU",
        "CCPU_VALIDATED" => "Validées CCPU",
        "PENDING_NDT" => "Att. CND",
        "COMPLETED" => "Terminées",
        "FINAL_VALIDATED" => "Validées final",
        "BLOCKED" => "Bloquées",
        _ => status
    };

    private string GetStatusColor(string status) => status switch
    {
        "PLANNED" => "bg-info",
        "IN_PROGRESS" => "bg-warning",
        "PENDING_CCPU" => "bg-orange",
        "CCPU_VALIDATED" => "bg-purple",
        "PENDING_NDT" => "bg-cyan",
        "COMPLETED" => "bg-success",
        "FINAL_VALIDATED" => "bg-success",
        "BLOCKED" => "bg-danger",
        _ => "bg-secondary"
    };

    private int GetStatusPercentage(int count)
    {
        if (dashboard.TotalWelds == 0) return 0;
        return (int)((double)count / dashboard.TotalWelds * 100);
    }

    private string GetSeverityClass(string severity) => severity?.ToUpper() switch
    {
        "CRITICAL" => "bg-danger",
        "MAJOR" => "bg-warning text-dark",
        "MINOR" => "bg-info",
        _ => "bg-secondary"
    };

    private string GetNCStatusClass(string status) => status?.ToUpper() switch
    {
        "OPEN" => "bg-danger",
        "ANALYSIS" => "bg-warning text-dark",
        "PENDING_ACTION" => "bg-info",
        "ACTION_IN_PROGRESS" => "bg-purple",
        "PENDING_VERIFICATION" => "bg-secondary",
        "CLOSED" => "bg-success",
        _ => "bg-secondary"
    };
}

<style>
    .dashboard { color: #f1f5f9; }
    .text-slate-400 { color: #94a3b8; }
    .text-slate-500 { color: #64748b; }
    .text-slate-300 { color: #cbd5e1; }
    .bg-slate-800 { background-color: #1e293b; }
    .bg-slate-600 { background-color: #475569; }
    .bg-purple { background-color: #8b5cf6 !important; }
    .bg-orange { background-color: #f97316 !important; }
    .bg-cyan { background-color: #06b6d4 !important; }
    .text-purple { color: #8b5cf6 !important; }

    .loading-container, .error-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
    }

    .stat-card {
        border-radius: 1rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        color: white;
    }

    .stat-card.bg-blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-card.bg-green { background: linear-gradient(135deg, #22c55e, #15803d); }
    .stat-card.bg-orange { background: linear-gradient(135deg, #f97316, #c2410c); }
    .stat-card.bg-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }

    .stat-icon { font-size: 2rem; }
    .stat-value { font-size: 2.5rem; font-weight: 700; }
    .stat-label { font-size: 0.9rem; opacity: 0.9; }
    .stat-trend { font-size: 0.8rem; opacity: 0.8; }
    .stat-trend.positive { color: #86efac; }
    .stat-trend.negative { color: #fca5a5; }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }

    .status-item {
        background: #0f172a;
        padding: 1rem;
        border-radius: 0.5rem;
    }

    .status-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #f1f5f9;
    }

    .status-label {
        font-size: 0.8rem;
        color: #94a3b8;
        margin-bottom: 0.5rem;
    }

    .status-bar {
        height: 4px;
        background: #334155;
        border-radius: 2px;
        overflow: hidden;
    }

    .status-fill {
        height: 100%;
        border-radius: 2px;
    }

    .quick-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .quick-stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #0f172a;
        border-radius: 0.5rem;
    }

    .stat-name { font-size: 0.85rem; }
    .stat-num { font-size: 1.25rem; font-weight: 700; }

    .table-dark {
        --bs-table-bg: transparent;
        --bs-table-hover-bg: rgba(139, 92, 246, 0.1);
    }

    .table-dark th {
        color: #94a3b8;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #334155;
    }

    .table-dark td {
        border-bottom: 1px solid #334155;
        vertical-align: middle;
    }

    .btn-outline-danger {
        border-color: #ef4444;
        color: #ef4444;
    }

    .btn-outline-danger:hover {
        background: #ef4444;
        color: white;
    }
</style>
